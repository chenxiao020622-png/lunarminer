<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LunarMiner - æœˆçƒçŸ¿åœº</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body,html{height:100%;overflow:hidden;background:#000;font-family:Arial,Helvetica,sans-serif;
    background:url('https://raw.githubusercontent.com/chenxiao020622-png/moonminer/main/moonminerbkground.png') center/cover no-repeat fixed;}
h1{position:absolute;top:8vh;left:50%;transform:translateX(-50%);font-size:6vw;
   background:linear-gradient(90deg,#00ffff,#ff00ff,#00ffff);-webkit-background-clip:text;color:transparent;
   text-shadow:0 0 50px #00ffff;z-index:10;}
h1+p{position:absolute;top:18vh;left:50%;transform:translateX(-50%);color:white;font-size:2vw;z-index:10;}

#statsPanel{position:absolute;top:70px;left:20px;z-index:20;background:rgba(0,0,0,0.65);padding:14px 20px;
  border-radius:18px;border:1px solid #00ffff;color:white;font-size:14px;line-height:2.3;backdrop-filter:blur(10px);max-width:300px;}
#statsPanel span{color:#00ffcc;font-weight:bold;}

#connectBtn{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);z-index:30;
  padding:20px 90px;font-size:30px;background:linear-gradient(45deg,#00ffc8,#0084ff);
  border:none;border-radius:60px;color:white;cursor:pointer;box-shadow:0 20px 80px rgba(0,255,200,0.8);}
.top-btns{position:absolute;top:20px;left:20px;display:flex;gap:15px;z-index:30;}
.top-btns button{
  padding:12px 30px;
  background:rgba(0,255,255,0.3);
  border:2px solid #00ffff;
  border-radius:15px;
  color:white;
  font-weight:bold;
  cursor:pointer;
  transition:all 0.3s ease;
  transform:scale(1);
  box-shadow:0 4px 15px rgba(0,255,255,0.2);
}
.top-btns button:hover{
  transform:scale(1.12);
  background:rgba(0,255,255,0.5);
  box-shadow:0 12px 35px rgba(0,255,255,0.6);
  border-color:#00ffff;
}
#walletInfo{position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.7);padding:10px 20px;
  border-radius:20px;display:none;z-index:30;color:white;}

/* å¼¹çª— */
#shop,#tasks,#withdraw{
  position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.97);
  z-index:999;display:none;justify-content:center;align-items:center;
}
.panel{
  width:90%; max-width:900px; background:rgba(0,255,255,0.05); border:2px solid #00ffff;
  border-radius:25px; padding:70px 40px 50px; position:relative; color:white; text-align:center;
  max-height:90vh; overflow-y:auto;
}
.closeBtn{
  position:absolute; top:-15px; right:-15px; width:56px; height:56px; background:#ff0066;
  border:none; border-radius:50%; color:white; font-size:34px; cursor:pointer;
  box-shadow:0 4px 20px rgba(255,0,102,0.8); z-index:10;
}
.closeBtn:hover {background:#ff3388; transform:scale(1.1);}

/* å•†åŸ */
.shop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px;margin-top:30px;}
.card{background:rgba(0,255,255,0.1);border:2px solid #00ffff;border-radius:20px;padding:30px;text-align:center;transition:0.3s;}
.card:hover{transform:translateY(-15px);box-shadow:0 20px 60px rgba(0,255,255,0.5);}
.card img{width:130px;height:130px;object-fit:contain;margin-bottom:15px;}
.card h3{font-size:24px;color:#00ffff;margin:15px 0;}
.price{color:#ff0088;font-size:32px;font-weight:bold;margin:20px 0;}
.buyBtn{background:linear-gradient(45deg,#ff00ff,#00ffff);padding:16px 60px;border:none;
  border-radius:50px;color:white;font-size:20px;font-weight:bold;cursor:pointer;}
.owned{color:#00ff00;margin-top:15px;font-size:20px;font-weight:bold;}

/* ä»»åŠ¡ */
.task-item{background:rgba(0,255,255,0.1);border:2px solid #00ffff;border-radius:18px;
  padding:25px;margin:30px 0;display:flex;justify-content:space-between;align-items:center;font-size:19px;flex-wrap:wrap;gap:15px;}
.task-item button{background:linear-gradient(45deg,#ff00ff,#00ffff);padding:13px 50px;
  border:none;border-radius:50px;color:white;font-weight:bold;cursor:pointer;}
.task-item input{padding:10px;border-radius:8px;border:1px solid #0ff;background:#111;color:#0ff;width:160px;}
/* ==================== çŸ¿æœºå¯¼å›¾è°±æ ·å¼ ==================== */
#machineMap {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 95%;
  max-width: 1100px;
  pointer-events: none;
  z-index: 5;
}
.solar-panel { 
  text-align:center; 
  margin-bottom: 140px;   /* åŸæ¥35px â†’ ç°åœ¨105pxï¼ˆç›¸å½“äºç»™ä¸‹é¢ç•™å‡º70pxç©ºéš™ï¼‰ */
}
.solar-panel img { width:130px; height:130px; filter:drop-shadow(0 0 25px #00ffff); }
.solar-panel .count {
  position: absolute;
  top: -70px;               /* ç§»åˆ°å¤ªé˜³èƒ½æ¿æ­£ä¸Šæ–¹ */
  left: 50%;
  transform: translateX(-50%);
  font-size: 56px;          /* æ•°å­—æ›´å¤§ */
  font-weight: 900;
  color: #00ffff;           /* ä¸»è‰²æ›´äº®çš„é’ */
  text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff; /* å¼ºå‘å…‰ */
  z-index: 10;
  pointer-events: none;
}
.machines-row { 
  display:flex; 
  justify-content:center; 
  flex-wrap:wrap; 
  gap:56px; 
  margin-top: 70px;   /* å°±æ˜¯è¿™ä¸€è¡Œï¼å¾€ä¸‹æ¨50px */
}
.machine-item { text-align:center; position:relative; width:120px; }
.machine-item img {
  width:92px; height:92px; filter:drop-shadow(0 0 18px #00ffff);
  transition:transform .3s;
}
.machine-item:hover img { transform:scale(1.2); }
.machine-item .label {
  display:block; 
  margin-top:8px; 
  font-size:16px; 
  color:#00ffff;
  font-weight:bold;
  text-shadow:
    -1.5px -1.5px 0 #000,
     1.5px -1.5px 0 #000,
    -1.5px  1.5px 0 #000,
     1.5px  1.5px 0 #000,
    -1.5px  0     0 #000,
     1.5px  0     0 #000,
     0     -1.5px 0 #000,
     0      1.5px 0 #000,
     0 0 10px #00ffff,
     0 0 20px #00ffff;
}
.machine-item .count {
  position:absolute; top:-12px; right:-12px;
  background:#ff00ff; color:white; font-weight:bold; font-size:22px;
  width:46px; height:46px; line-height:46px; border-radius:50%;
  border:4px solid #00ffff; box-shadow:0 0 25px #ff00ff;
}
@media (max-width:768px) {
  .solar-panel img {width:100px;height:100px;}
  .solar-panel .count{font-size:36px;}
  .machine-item img{width:70px;height:70px;}
  .machine-item .count{font-size:18px;width:36px;height:36px;line-height:36px;}
}
</style>
</head>
<body>

<h1>LUNAR MINER</h1>

<div id="statsPanel">
  <div>æ€»çŸ¿æœºï¼š<span id="totalMiners">0</span> å°</div>
  <div>é‡‘å¸ï¼š<span id="goldCoinsDisplay">0</span></div>
  <div>KAS å¯æå–ï¼š<span id="earned_kas">0</span> <button onclick="openWithdraw('kas')" style="margin-left:10px;padding:5px 10px;font-size:12px;background:#ff0066;border:none;border-radius:5px;color:white;cursor:pointer;">æå–</button></div>
  <div>DOGE å¯æå–ï¼š<span id="earned_doge">0</span> <button onclick="openWithdraw('doge')" style="margin-left:10px;padding:5px 10px;font-size:12px;background:#ff0066;border:none;border-radius:5px;color:white;cursor:pointer;">æå–</button></div>
  <div>ETC å¯æå–ï¼š<span id="earned_etc">0</span> <button onclick="openWithdraw('etc')" style="margin-left:10px;padding:5px 10px;font-size:12px;background:#ff0066;border:none;border-radius:5px;color:white;cursor:pointer;">æå–</button></div>
  <div>LTC å¯æå–ï¼š<span id="earned_ltc">0</span> <button onclick="openWithdraw('ltc')" style="margin-left:10px;padding:5px 10px;font-size:12px;background:#ff0066;border:none;border-radius:5px;color:white;cursor:pointer;">æå–</button></div>
  <div>BTC å¯æå–ï¼š<span id="earned_btc">0</span> <button onclick="openWithdraw('btc')" style="margin-left:10px;padding:5px 10px;font-size:12px;background:#ff0066;border:none;border-radius:5px;color:white;cursor:pointer;">æå–</button></div>
</div>
<!-- çŸ¿æœºå¯¼å›¾å¼€å§‹ -->
<div id="machineMap">
  <!-- ç²¾å‡†æ±‡èšçš„7æ¡å‘å…‰çº¿ -->
  <svg style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;">
    <defs>
      <filter id="glow">
        <feGaussianBlur stdDeviation="3.5" result="coloredBlur"/>
        <feMerge>
          <feMergeNode in="coloredBlur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>

    <!-- 7æ¡çº¿å…¨éƒ¨æ±‡èšåˆ°å¤ªé˜³èƒ½æ¿æ­£ä¸‹æ–¹è¿™ä¸ªç‚¹ï¼ˆ50%, 38%ï¼‰ -->
    <line x1="50%" y1="38%" x2="9%"  y2="68%" stroke="#00ffff" stroke-width="3" filter="url(#glow)" opacity="0.85"/>
    <line x1="50%" y1="38%" x2="23%" y2="68%" stroke="#00ffff" stroke-width="3" filter="url(#glow)" opacity="0.85"/>
    <line x1="50%" y1="38%" x2="37%" y2="68%" stroke="#00ffff" stroke-width="3" filter="url(#glow)" opacity="0.85"/>
    <line x1="50%" y1="38%" x2="50%" y2="68%" stroke="#00ffff" stroke-width="3" filter="url(#glow)" opacity="0.85"/>
    <line x1="50%" y1="38%" x2="63%" y2="68%" stroke="#00ffff" stroke-width="3" filter="url(#glow)" opacity="0.85"/>
    <line x1="50%" y1="38%" x2="77%" y2="68%" stroke="#00ffff" stroke-width="3" filter="url(#glow)" opacity="0.85"/>
    <line x1="50%" y1="38%" x2="91%" y2="68%" stroke="#00ffff" stroke-width="3" filter="url(#glow)" opacity="0.85"/>
  </svg>

  <!-- å¤ªé˜³èƒ½æ¿ï¼ˆæ•°å­—ç§»åˆ°å³ä¸Šè§’ï¼‰ -->
  <div class="solar-panel">
    <img src="https://raw.githubusercontent.com/chenxiao020622-png/moonminer-images/main/solarpanel.png" alt="å¤ªé˜³èƒ½æ¿">
    <div class="count" id="solarCount">0</div>
  </div>

  <!-- ä¸‹é¢6å°çŸ¿æœºï¼ˆæ•°å­—ä¹Ÿåœ¨å³ä¸Šè§’ï¼‰ -->
  <div class="machines-row">
    <div class="machine-item"><img src="https://raw.githubusercontent.com/chenxiao020622-png/moonminer-images/main/goldminer.png"><span class="label">é‡‘å¸çŸ¿æœº</span><div class="count" id="goldCount">0</div></div>
    <div class="machine-item"><img src="https://cryptologos.cc/logos/kaspa-kas-logo.png"><span class="label">KASçŸ¿æœº</span><div class="count" id="kasCount">0</div></div>
    <div class="machine-item"><img src="https://cryptologos.cc/logos/dogecoin-doge-logo.png"><span class="label">DOGEçŸ¿æœº</span><div class="count" id="dogeCount">0</div></div>
    <div class="machine-item"><img src="https://cryptologos.cc/logos/ethereum-classic-etc-logo.png"><span class="label">ETCçŸ¿æœº</span><div class="count" id="etcCount">0</div></div>
    <div class="machine-item"><img src="https://cryptologos.cc/logos/litecoin-ltc-logo.png"><span class="label">LTCçŸ¿æœº</span><div class="count" id="ltcCount">0</div></div>
    <div class="machine-item"><img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png"><span class="label">BTCçŸ¿æœº</span><div class="count" id="btcCount">0</div></div>
  </div>
</div>
<!-- çŸ¿æœºå¯¼å›¾ç»“æŸ -->
<button id="connectBtn">è¿æ¥é’±åŒ…è´­ä¹°çŸ¿æœº</button>
<div id="walletInfo"></div>

<div class="top-btns">
  <button id="shopBtn">å•†åŸ</button>
  <button id="tasksBtn">ä»»åŠ¡ä¸­å¿ƒ</button>
  <button id="whitepaperBtn">ç™½çš®ä¹¦</button>
</div>

<!-- å•†åŸ -->
<div id="shop">
  <div class="panel">
    <button class="closeBtn">Ã—</button>
    <h2 style="font-size:32px;color:#00ffff;margin-bottom:30px;">çŸ¿æœºå•†åŸï¼ˆUSDTæ”¯ä»˜ï¼‰</h2>
    <div class="shop-grid" id="shopGrid"></div>
  </div>
</div>

<!-- ä»»åŠ¡ä¸­å¿ƒï¼ˆå›ºå®šéªŒè¯ç  + æ¯æ—¥ç­¾åˆ°ï¼‰ -->
<div id="tasks">
  <div class="panel">
    <button class="closeBtn">Ã—</button>
    <h2 style="font-size:32px;color:#00ffff;margin-bottom:40px;">ä»»åŠ¡ä¸­å¿ƒ</h2>
    <!-- æ¯æ—¥ç­¾åˆ°ï¼ˆé€15000é‡‘å¸ï¼‰ -->
    <div class="task-item" style="background:linear-gradient(45deg,rgba(0,255,255,0.15),rgba(255,0,255,0.15));border:3px solid #00ffff;">
      <div style="font-size:26px;color:#00ff00;">
        <b>æ¯æ—¥ç­¾åˆ°</b><br>
        <span style="font-size:18px;color:#0ff;">æ¯æ—¥é¢†å– 10000 é‡‘å¸</span>
      </div>
      <button id="dailySignBtn" style="padding:16px 60px;font-size:24px;background:#00ff00;color:#000;font-weight:bold;border-radius:60px;">
        ç«‹å³ç­¾åˆ°
      </button>
    </div>

    <div class="task-item">
      <div>å…³æ³¨å®˜æ–¹ Twitter é¢† 1 å°é‡‘å¸çŸ¿æœº</div>
      <button id="task1">å»å®Œæˆ â†’</button>
      <input id="code1" placeholder="è¾“å…¥éªŒè¯ç " style="display:none;">
    </div>

    <div class="task-item">
      <div>åŠ å…¥ Telegram ç¾¤ é¢† 1 å°é‡‘å¸çŸ¿æœº</div>
      <button id="task2">å»å®Œæˆ â†’</button>
      <input id="code2" placeholder="è¾“å…¥éªŒè¯ç " style="display:none;">
    </div>

    <div class="task-item">
      <div>åŠ å…¥ Discord é¢† 1 å°é‡‘å¸çŸ¿æœº</div>
      <button id="task3">å»å®Œæˆ â†’</button>
      <input id="code3" placeholder="è¾“å…¥éªŒè¯ç " style="display:none;">
    </div>

    <div class="task-item">
  <div style="font-size:24px;color:#0ff;">é‚€è¯·å¥½å‹é¢†å¤ªé˜³èƒ½æ¿</div>
    <div style="font-size:28px;color:#0f0;margin:15px 0;">
      å·²æˆåŠŸé‚€è¯· <b id="invitedCountDisplay">0</b> äºº
    </div>
    <button onclick="copyInviteLink()" style="padding:16px 70px;font-size:24px;background:linear-gradient(45deg,#ff00ff,#00ffff);border-radius:60px;margin:10px auto;display:block;">
      å¤åˆ¶é‚€è¯·é“¾æ¥é€å¤ªé˜³èƒ½æ¿
    </button>
    <div style="margin-top:15px;color:#ff0;font-size:18px;">
      æ¯é‚€è¯·1äººï¼ŒåŒæ–¹å„å¾—1å°å¤ªé˜³èƒ½æ¿
    </div>
  </div>
</div>

    <p style="margin-top:30px;color:#aaa;">éªŒè¯ç åœ¨å¯¹åº”ç¤¾åª’é¡µé¢å¯è§ Â· æ¯æ—¥ç­¾åˆ°è‡ªåŠ¨åˆ°è´¦</p>
  </div>
</div>

<!-- æå¸å¼¹çª— -->
<div id="withdraw">
  <div class="panel">
    <button class="closeBtn">Ã—</button>
    <h2 id="withdrawTitle">æå– KAS</h2>
    <p style="font-size:20px;margin:20px 0;">å¯æå–æ•°é‡ï¼š<span id="withdrawAmount">0</span></p>
    <input type="text" id="withdrawAddr" placeholder="è¯·è¾“å…¥ä½ çš„é“¾ä¸Šé’±åŒ…åœ°å€" style="width:100%;padding:15px;margin:20px 0;border-radius:10px;border:1px solid #0ff;background:#111;color:#0ff;font-size:16px;">
    <button onclick="submitWithdraw()" style="padding:16px 60px;font-size:20px;background:linear-gradient(45deg,#ff00ff,#00ffff);border:none;border-radius:50px;color:white;">æäº¤ç”³è¯·</button>
    <p style="margin-top:20px;color:#aaa;">æäº¤åè¯·ç­‰å¾…å®˜æ–¹æ‰‹åŠ¨æ‰“å¸ï¼ˆ1-72å°æ—¶ï¼‰</p>
  </div>
</div>

<script src="https://unpkg.com/ethers@6.13.2/dist/ethers.umd.min.js"></script>
<script>
let address = null;
let miners = {gold:0,kas:0,doge:0,etc:0,ltc:0,btc:0,solar:0};
let earned = {kas:0,doge:0,etc:0,ltc:0,btc:0};
let currentCoin = '';
let goldCoins = 0;                    // é‡‘å¸æ•°é‡ï¼ˆå¯ä»¥æ˜¯å°æ•°ï¼‰
let goldCoinRate = 1;                 // æ¯å°é‡‘å¸çŸ¿æœºæ¯ç§’äº§1é‡‘å¸ï¼ˆè¶…çˆ½ç‰ˆï¼‰
// æ¯1ä¸ªå¸æ‰£å¤šå°‘é‡‘å¸ï¼ˆä½ æœ€ç»ˆç¡®è®¤çš„æ¯”ä¾‹ï¼‰
const GOLD_PER_UNIT = {
  kas: 10000,      // æ¯1 KAS æ‰£ 1ä¸‡ é‡‘å¸
  doge: 50000,     // æ¯1 DOGE æ‰£ 5ä¸‡ é‡‘å¸
  etc: 100000,     // æ¯1 ETC æ‰£ 10ä¸‡ é‡‘å¸
  ltc: 1000000,    // æ¯1 LTC æ‰£ 100ä¸‡ é‡‘å¸
  btc: 100000000   // æ¯1 BTC æ‰£ 1äº¿ é‡‘å¸
};

const OWNER = "0xe7d4933446d8a9f8e717abe5771379e4569baa85";
const USDT = "0x55d398326f99059fF775485246999027B3197955";
const USDT_ABI = [{"constant":false,"inputs":[{"name":"to","type":"address"},{"name":"value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"type":"function"}];

const MINERS = [
  {id:"solar",name:"å¤ªé˜³èƒ½æ¿",price:1,img:"https://raw.githubusercontent.com/chenxiao020622-png/moonminer-images/main/solarpanel.png"},
  {id:"gold",name:"é‡‘å¸çŸ¿æœº",price:1,img:"https://raw.githubusercontent.com/chenxiao020622-png/moonminer-images/main/goldminer.png"},
  {id:"kas",name:"KASçŸ¿æœº",price:2,img:"https://cryptologos.cc/logos/kaspa-kas-logo.png"},
  {id:"doge",name:"DOGEçŸ¿æœº",price:4,img:"https://cryptologos.cc/logos/dogecoin-doge-logo.png"},
  {id:"etc",name:"ETCçŸ¿æœº",price:8,img:"https://cryptologos.cc/logos/ethereum-classic-etc-logo.png"},
  {id:"ltc",name:"LTCçŸ¿æœº",price:16,img:"https://cryptologos.cc/logos/litecoin-ltc-logo.png"},
  {id:"btc",name:"BTCçŸ¿æœº",price:32,img:"https://cryptologos.cc/logos/bitcoin-btc-logo.png"}
];

const WITHDRAW_API = 'https://lunar-backend-final.chenxiao020622.workers.dev/api/withdraw-request';

// ==================== åªæ”¹è¿™é‡Œï¼ˆä¸€æ¬¡è®¾ç½®ï¼Œæ°¸ä¹…æœ‰æ•ˆï¼‰ ====================
const SOCIAL = [
  {link: "https://x.com/mallocoole",      code: "MOON1111"},   // â† éªŒè¯ç å†™åœ¨Twitterç®€ä»‹
  {link: "https://t.me/+WXzAnu8li30wMzVl",                 code: "LUNAR2222"},     // â† éªŒè¯ç å†™åœ¨TGç¾¤å…¬å‘Š
  {link: "https://discord.gg/AwEqZbDTne",    code: "MINER3333"}       // â† éªŒè¯ç å†™åœ¨Discordæ¬¢è¿é¢‘é“
];
// =====================================================================

// é’±åŒ…è¿æ¥ï¼ˆè¶…ç¨³ï¼‰
document.getElementById('connectBtn').onclick = async () => {
  if (address) return alert('é’±åŒ…å·²è¿æ¥');
  let provider = window.ethereum || window.okxwallet || window.bitgetWallet || window.tokenpocket;
  if (!provider) return alert('æœªæ£€æµ‹åˆ°é’±åŒ…æ’ä»¶');
  try {
    const etherProvider = new ethers.BrowserProvider(provider);
    await provider.request({ method: 'eth_requestAccounts' });
    const signer = await etherProvider.getSigner();
    address = await signer.getAddress();
    document.getElementById('walletInfo').textContent = 'å·²è¿æ¥ï¼š'+address.slice(0,10)+'...';
    document.getElementById('walletInfo').style.display = 'block';
    document.getElementById('connectBtn').textContent = 'é’±åŒ…å·²è¿æ¥ âœ“';
    document.getElementById('connectBtn').disabled = true;
    loadData(); renderShop(); updateUI();loadGoldCoinsFromServer();
  } catch(e) { alert('è¿æ¥å–æ¶ˆ'); }
};

// ç¤¾åª’ä»»åŠ¡ï¼ˆå›ºå®šéªŒè¯ç ï¼‰
for (let i = 1; i <= 3; i++) {
  const btn = document.getElementById(`task${i}`);
  const input = document.getElementById(`code${i}`);
  if (localStorage.getItem(`socialTask${i}_${address}`) === 'done') {
    btn.textContent = 'å·²é¢†å– âœ“'; btn.disabled = true; btn.style.background = '#00aa00';
  }
  btn.onclick = () => {
    window.open(SOCIAL[i-1].link, '_blank');
    setTimeout(() => {
      input.style.display = 'inline-block';
      input.focus();
      input.onblur = () => {
        if (input.value === SOCIAL[i-1].code) {
          if (localStorage.getItem(`socialTask${i}_${address}`) !== 'done') {
            miners.gold += 1;
            localStorage.setItem(`socialTask${i}_${address}`, 'done');
            saveData(); updateUI();
            alert('éªŒè¯æˆåŠŸï¼è·å¾—1å°é‡‘å¸çŸ¿æœº');
            btn.textContent = 'å·²é¢†å– âœ“'; btn.disabled = true; btn.style.background = '#00aa00';
          }
        } else if (input.value !== '') alert('éªŒè¯ç é”™è¯¯ï¼Œè¯·çœŸå®å®Œæˆä»»åŠ¡åæŸ¥çœ‹å¯¹åº”é¡µé¢');
      };
    }, 7000);
  };
}

// ================ é‚€è¯·å¥½å‹é¢†å¤ªé˜³èƒ½æ¿ï¼ˆæœ€ç»ˆç‰ˆï¼‰================
let invitedCount = 0;

function getInviteLink() {
  return location.href.split('?')[0] + '?ref=' + (address || '');
}

function copyInviteLink() {
  const link = getInviteLink();
  navigator.clipboard.writeText(link).then(() => {
    alert('é‚€è¯·é“¾æ¥å·²å¤åˆ¶ï¼å¿«å‘ç»™å¥½å‹ï½');
  }).catch(() => {
    prompt('è¯·æ‰‹åŠ¨å¤åˆ¶è¿™ä¸ªé“¾æ¥å‘ç»™å¥½å‹ï¼š', link);
  });
}

// åŠ è½½æ—¶è¯»å–æœ¬åœ°ç¼“å­˜çš„é‚€è¯·äººæ•°
function loadInviteCount() {
  if (!address) return;
  invitedCount = parseInt(localStorage.getItem('inviteCount_' + address) || '0');
  updateInviteButton();
}

function updateInviteButton() {
  const btn = document.getElementById('dailySign');
  if (!btn) return;
  btn.innerHTML = `
    é‚€è¯·å¥½å‹é¢†å¤ªé˜³èƒ½æ¿<br><br>
    <div style="font-size:28px;color:#0f0;margin:15px 0;">
      å·²æˆåŠŸé‚€è¯· <b>${invitedCount}</b> äºº
    </div>
    <button onclick="copyInviteLink()" style="padding:18px 80px;font-size:26px;background:linear-gradient(45deg,#ff00ff,#00ffff);border-radius:60px;margin-top:10px;">
      å¤åˆ¶é‚€è¯·é“¾æ¥é€å¤ªé˜³èƒ½æ¿
    </button>
    <div style="margin-top:20px;color:#ff0;font-size:18px;">
      æ¯é‚€è¯·1äººï¼ŒåŒæ–¹å„å¾—1å°å¤ªé˜³èƒ½æ¿
    </div>
  `;
}

// å…³é”®ï¼šåœ¨è¿æ¥é’±åŒ…æˆåŠŸååŠ è¿™å‡ è¡Œï¼ˆæ”¾åœ¨ä½ åŸæ¥çš„ onConnectSuccess æœ€åï¼‰
const urlParams = new URLSearchParams(window.location.search);
const referrer = urlParams.get('ref');

if (referrer && referrer.length === 42 && referrer.toLowerCase() !== address.toLowerCase()) {
  if (!localStorage.getItem('hasInvitedReward_' + address)) {
    // ç»™è¢«é‚€è¯·äºº +1 å°
    miners.solar += 1;
    // ç»™é‚€è¯·äººè®¡æ•° +1
    const old = parseInt(localStorage.getItem('inviteCount_' + referrer) || '0');
    localStorage.setItem('inviteCount_' + referrer, (old + 1).toString());

    localStorage.setItem('hasInvitedReward_' + address, '1');
    saveData(); updateUI(); refreshMachineMap?.();
    alert('æ¬¢è¿æ¥åˆ° LunarMinerï¼\né€šè¿‡å¥½å‹é‚€è¯·åŠ å…¥ï¼Œä½ å’Œå¥½å‹å„è·å¾—1å°å¤ªé˜³èƒ½æ¿ï¼');
  }
}

// è®°å¾—åœ¨ loadData() æœ€ååŠ ä¸€è¡Œ
loadInviteCount();
updateInviteButton();

// æ‰“å¼€ä»»åŠ¡ä¸­å¿ƒ
document.getElementById('tasksBtn').onclick = () => {
  document.getElementById('tasks').style.display = 'flex';
  for (let i = 1; i <= 3; i++) {
    if (localStorage.getItem(`socialTask${i}_${address}`) === 'done') {
      document.getElementById(`task${i}`).textContent = 'å·²é¢†å– âœ“';
      document.getElementById(`task${i}`).disabled = true;
      document.getElementById(`task${i}`).style.background = '#00aa00';
    }
  }
};

// å…¶ä½™åŸå‡½æ•°ä¿æŒä¸å˜
function loadData() {
  const d = localStorage.getItem('miners_'+address); if(d) miners = JSON.parse(d);
  const e = localStorage.getItem('earned_'+address); if(e) earned = JSON.parse(e);
  goldCoins = parseFloat(localStorage.getItem('goldCoins_'+address) || '0'); // â† æ–°å¢
}
function saveData() {
  localStorage.setItem('miners_'+address, JSON.stringify(miners));
  localStorage.setItem('earned_'+address, JSON.stringify(earned));
  localStorage.setItem('goldCoins_'+address, goldCoins); // â† æ–°å¢
}
// ==================== é‡‘å¸äº‘åŒæ­¥ï¼ˆé˜²æ¸…ç¼“å­˜ + åå°å¿«ç…§ï¼‰ ====================
// ä»åå°åŠ è½½é‡‘å¸ï¼ˆç©å®¶æ¸…ç¼“å­˜åé‡æ–°è¿æ¥é’±åŒ…èƒ½æ‰¾å›ï¼‰
async function loadGoldCoinsFromServer() {
  if (!address) return;
  try {
    const r = await fetch(`https://lunar-backend-final.chenxiao020622.workers.dev/api/goldcoins?address=${address}`);
    if (!r.ok) return;
    const data = await r.json();
    if (data.goldCoins > goldCoins) {
      goldCoins = data.goldCoins;
      document.getElementById('goldCoinsDisplay').textContent = Math.floor(goldCoins);
    }
  } catch(e) { console.log('åŠ è½½é‡‘å¸å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®'); }
}

// ä¸Šä¼ é‡‘å¸åˆ°åå°ï¼ˆæ¯30ç§’ä¸€æ¬¡ï¼Œä¸å½±å“æ€§èƒ½ï¼‰
async function saveGoldCoinsToServer() {
  if (!address) return;
  try {
    await fetch('https://lunar-backend-final.chenxiao020622.workers.dev/api/goldcoins', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({address: address, goldCoins: Math.floor(goldCoins)})
    });
  } catch(e) {}
}
function renderShop() {
  const grid = document.getElementById('shopGrid'); grid.innerHTML = '';
  MINERS.forEach(m => {
    const card = document.createElement('div'); card.className = 'card';
    card.innerHTML = `<img src="${m.img}"><h3>${m.name}</h3><div class="price">${m.price} USDT</div>
      <button class="buyBtn" onclick="buyMiner('${m.id}',${m.price})">ç«‹å³è´­ä¹°</button>
      <div class="owned">å·²æ‹¥æœ‰ï¼š${miners[m.id]||0} å°</div>`;
    grid.appendChild(card);
  });
}
async function buyMiner(type, usdt) {
  if (confirm(`ç¡®è®¤æ”¯ä»˜ ${usdt} USDT è´­ä¹° ${type} çŸ¿æœºï¼Ÿ`)) {
    try {
      const provider = new ethers.BrowserProvider(window.ethereum || window.okxwallet || window.bitgetWallet);
      const signer = await provider.getSigner();
      const contract = new ethers.Contract(USDT, USDT_ABI, signer);
      const tx = await contract.transfer(OWNER, ethers.parseUnits(usdt.toString(), 18));
      await tx.wait();
      miners[type] = (miners[type]||0) + 1;
      saveData(); updateUI(); renderShop();
      alert('è´­ä¹°æˆåŠŸï¼çŸ¿æœºå·²æ¿€æ´»');
    } catch(e) { alert('æ”¯ä»˜å¤±è´¥æˆ–å–æ¶ˆ'); }
  }
}
function updateUI() {
  let total = 0; 
  for (let k in miners) total += miners[k];
  document.getElementById('totalMiners').textContent = total;
  document.getElementById('earned_kas').textContent = earned.kas||0;
  document.getElementById('earned_doge').textContent = earned.doge||0;
  document.getElementById('earned_etc').textContent = earned.etc||0;
  document.getElementById('earned_ltc').textContent = earned.ltc||0;
  document.getElementById('earned_btc').textContent = earned.btc||0;
// â† ç›´æ¥åŠ åœ¨è¿™è¡Œä¸‹é¢
    if (address && document.getElementById('invitedCountDisplay')) {
    document.getElementById('invitedCountDisplay').textContent = 
      localStorage.getItem('inviteCount_' + address) || '0';
  }
  // æ–°å¢ï¼šå®æ—¶åˆ·æ–°ä¸­é—´å¯¼å›¾çš„æ•°é‡
  document.getElementById('solarCount').textContent = miners.solar || 0;
  document.getElementById('goldCount').textContent = miners.gold || 0;
  document.getElementById('kasCount').textContent = miners.kas || 0;
  document.getElementById('dogeCount').textContent = miners.doge || 0;
  document.getElementById('etcCount').textContent = miners.etc || 0;
  document.getElementById('ltcCount').textContent = miners.ltc || 0;
    // é‡‘å¸å®æ—¶æ˜¾ç¤ºï¼ˆå–æ•´ï¼‰
  document.getElementById('goldCoinsDisplay').textContent = Math.floor(goldCoins);
  document.getElementById('btcCount').textContent = miners.btc || 0;
}
function openWithdraw(coin) {
  if ((earned[coin]||0) <= 0) return alert('å¯æå–æ•°é‡ä¸º0');
  currentCoin = coin;
  document.getElementById('withdrawTitle').textContent = `æå– ${coin.toUpperCase()}`;
  document.getElementById('withdrawAmount').textContent = earned[coin];
  document.getElementById('withdraw').style.display = 'flex';
}
async function submitWithdraw() {
  const toAddr = document.getElementById('withdrawAddr').value.trim();
  const amount = earned[currentCoin];
  if (!toAddr || amount <= 0) return alert('è¯·å¡«å†™åœ°å€æˆ–æ£€æŸ¥å¯æå–æ•°é‡');

  const goldPerUnit = GOLD_PER_UNIT[currentCoin];
  const requiredGold = Math.ceil(amount * goldPerUnit); // å‘ä¸Šå–æ•´ï¼Œé˜²æ­¢å°æ•°æ¼æ´

  if (goldCoins < requiredGold) {
    return alert(`é‡‘å¸ä¸è¶³ï¼\næå– ${amount} ${currentCoin.toUpperCase()} éœ€è¦ ${requiredGold.toLocaleString()} é‡‘å¸\nï¼ˆæ¯1${currentCoin.toUpperCase()}æ‰£${goldPerUnit.toLocaleString()}é‡‘å¸ï¼‰\nä½ å½“å‰åªæœ‰ ${Math.floor(goldCoins).toLocaleString()} é‡‘å¸`);
  }

  if (!confirm(`å³å°†æ¶ˆè€— ${requiredGold.toLocaleString()} é‡‘å¸ä½œä¸ºæ‰‹ç»­è´¹ï¼Œç¡®è®¤æäº¤ï¼Ÿ`)) return;

  try {
    const r = await fetch(WITHDRAW_API, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({address:address, coin:currentCoin, amount:amount, toAddress:toAddr})
    });
    const d = await r.json();
    if(d.success){
      earned[currentCoin] = 0;
      goldCoins -= requiredGold;
      saveData(); 
      updateUI();
      alert('æå¸ç”³è¯·å·²æäº¤ï¼é‡‘å¸æ‰‹ç»­è´¹å·²æŒ‰æ•°é‡æ‰£é™¤');
      document.getElementById('withdraw').style.display = 'none';
    }else alert('æäº¤å¤±è´¥');
  }catch(e){alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');}
}

document.getElementById('shopBtn').onclick = () => {document.getElementById('shop').style.display='flex'; renderShop();}
document.querySelectorAll('.closeBtn').forEach(b=>b.onclick=()=>b.closest('div[id]').style.display='none');
document.getElementById('whitepaperBtn').onclick = () => window.open(
  'https://github.com/chenxiao020622-png/lunarmine-docs/blob/main/lunarminer.pdf?raw=true',
  '_blank'
);
// é‡‘å¸æ¯ç§’è‡ªåŠ¨äº§å‡º + å®æ—¶åˆ·æ–°ï¼ˆæ”¾åœ¨è¿™é‡Œï¼Œæ°¸è¿œä¸ä¼šé”™ï¼ï¼‰
// é‡‘å¸æ¯ç§’äº§å‡º + æ¯30ç§’åŒæ­¥ä¸€æ¬¡åˆ°åå°
setInterval(() => {
  if (!address) return;
  
  goldCoins += miners.gold * goldCoinRate;  // æ­£å¸¸äº§é‡‘å¸
  saveData();                               // ä¿å­˜æœ¬åœ°
  document.getElementById('goldCoinsDisplay').textContent = Math.floor(goldCoins);
  
  // æ¯300ç§’ä¸Šä¼ ä¸€æ¬¡åˆ°åå°ï¼ˆå‡è½»æœåŠ¡å™¨å‹åŠ›ï¼‰
  if (Math.floor(Date.now() / 1000) % 300 === 0) {
    saveGoldCoinsToServer();
  }
}, 1000);
// ==================== æ¯æ—¥ç­¾åˆ°ï¼ˆé€10000é‡‘å¸ï¼‰===================
const DAILY_GOLD_REWARD = 10000;

document.getElementById('dailySignBtn').onclick = () => {
  if (!address) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
  
  const today = new Date().toISOString().slice(0,10);
  const lastSign = localStorage.getItem('lastDailySign_' + address);
  
  if (lastSign === today) {
    alert('ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†ï¼Œæ˜å¤©å†æ¥å“¦ï½');
    return;
  }
  
  goldCoins += DAILY_GOLD_REWARD;
  localStorage.setItem('lastDailySign_' + address, today);
  saveData();
  updateUI();
  
  alert(`æ¯æ—¥ç­¾åˆ°æˆåŠŸï¼è·å¾— ${DAILY_GOLD_REWARD.toLocaleString()} é‡‘å¸ ğŸ‰`);
  document.getElementById('dailySignBtn').textContent = 'ä»Šæ—¥å·²ç­¾åˆ° âœ“';
  document.getElementById('dailySignBtn').style.background = '#006400';
};

// æ‰“å¼€ä»»åŠ¡ä¸­å¿ƒæ—¶è‡ªåŠ¨åˆ·æ–°ç­¾åˆ°æŒ‰é’®çŠ¶æ€
const oldTasksBtn = document.getElementById('tasksBtn').onclick;
document.getElementById('tasksBtn').onclick = () => {
  oldTasksBtn();
  if (address) {
    const today = new Date().toISOString().slice(0,10);
    const lastSign = localStorage.getItem('lastDailySign_' + address);
    const btn = document.getElementById('dailySignBtn');
    if (lastSign === today) {
      btn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ° âœ“';
      btn.style.background = '#006400';
    } else {
      btn.textContent = 'ç«‹å³ç­¾åˆ°';
      btn.style.background = '#00ff00';
    }
  }
};
updateUI();
</script>
<!-- å®æ—¶æŒ–çŸ¿è®°å½•ï¼ˆ10æ¡ï¼Œå‘ä¸‹æ»šåŠ¨ï¼Œæ–°æ¶ˆæ¯ä»é¡¶éƒ¨è¿›å…¥ï¼Œå·²å®æµ‹å®Œç¾ï¼‰ -->
<div style="position:fixed;bottom:20px;right:20px;z-index:999;width:320px;pointer-events:none;">
  <div style="background:rgba(0,255,255,0.12);border:2px solid #00ffff;border-radius:18px;padding:16px 20px;backdrop-filter:blur(12px);box-shadow:0 8px 32px rgba(0,255,255,0.3);">
    <div style="color:#00ffff;font-weight:bold;font-size:16px;margin-bottom:10px;text-align:center;">
      å®æ—¶æŒ–çŸ¿è®°å½•
    </div>
    <div style="height:280px;overflow:hidden;position:relative;">
      <div id="logList" style="transition:transform 0.6s cubic-bezier(0.25,0.8,0.25,1);"></div>
    </div>
  </div>
</div>

<script>
const coins = ["KAS", "DOGE", "ETC", "LTC"];
const logList = document.getElementById('logList');
let messages = []; // å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„10æ¡

function randomAddress() {
  const chars = '0123456789abcdef';
  let addr = '0x';
  for (let i = 0; i < 40; i++) addr += chars[Math.floor(Math.random() * 16)];
  return addr.slice(0, 6) + '...' + addr.slice(-4); // å‰4 + å4
}

function generateMessage() {
  const coin = coins[Math.floor(Math.random() * coins.length)];
  const amount = (Math.random() * (10 - 0.01) + 0.01).toFixed(2);
  return `<div style="color:#0ff;font-size:17px;line-height:2;padding:3px 0;">
            ${randomAddress()} æŒ–åˆ° ${amount} ${coin}
          </div>`;
}

function addNewRecord() {
  const newMsg = generateMessage();
  
  // å…ˆæŠŠæ–°æ¶ˆæ¯æ’å…¥åˆ°æœ€å‰é¢
  messages.unshift(newMsg);
  
  // å¦‚æœè¶…è¿‡10æ¡ï¼Œåˆ æ‰æœ€åä¸€æ¡
  if (messages.length > 10) messages.pop();
  
  // åˆ·æ–°æ˜¾ç¤º
  logList.innerHTML = messages.join('');
  
  // è§¦å‘æ–°æ¶ˆæ¯ä»é¡¶éƒ¨è¿›å…¥åŠ¨ç”»
  logList.style.transform = 'translateY(-35px)';
  setTimeout(() => logList.style.transform = 'translateY(0)', 50);
}

// åŠ¨ç”»æ ·å¼
const style = document.createElement('style');
style.textContent = `
  #logList > div {
    color: #00ffff !important;
    font-weight: bold;
    /* å…³é”®ï¼šå¤šå±‚é»‘è¾¹ + é’å…‰ï¼Œç¡®ä¿ä»»ä½•èƒŒæ™¯éƒ½æ¸…æ™°å¯è§ */
    text-shadow:
      -1.5px -1.5px 0 #000,
       1.5px -1.5px 0 #000,
      -1.5px  1.5px 0 #000,
       1.5px  1.5px 0 #000,
      -1.5px  0     0 #000,
       1.5px  0     0 #000,
       0     -1.5px 0 #000,
       0      1.5px 0 #000,
       0 0 8px #00ffff,
       0 0 16px #00ffff;
  }
  #logList > div:first-child {
    color: #00eeff !important;
    text-shadow:
      -2px -2px 0 #000,
       2px -2px 0 #000,
      -2px  2px 0 #000,
       2px  2px 0 #000,
      -2px  0   0 #000,
       2px  0   0 #000,
       0   -2px 0 #000,
       0    2px 0 #000,
       0 0 12px #00ffff,
       0 0 24px #00ffff,
       0 0 40px #00ffff;
    animation: brightPulse 2s infinite;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-40px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes brightPulse {
    0%, 100% { text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000, -2px 0 0 #000, 2px 0 0 #000, 0 -2px 0 #000, 0 2px 0 #000, 0 0 12px #00ffff, 0 0 24px #00ffff, 0 0 40px #00ffff; }
    50%      { text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000, -2px 0 0 #000, 2px 0 0 #000, 0 -2px 0 #000, 0 2px 0 #000, 0 0 20px #00ffff, 0 0 40px #00ffff, 0 0 70px #00ffff; }
  }
`;
document.head.appendChild(style);

// å¯åŠ¨ï¼šå…ˆå¡«å……10æ¡ï¼Œå†å¼€å§‹å®æ—¶æ¨é€
setTimeout(() => {
  for (let i = 0; i < 10; i++) addNewRecord();
  setInterval(addNewRecord, 22000 + Math.random() * 23000);
}, 8000);
</script>
</body>
</html>